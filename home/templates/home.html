{% extends "base.html" %}
{% block start %}

<h2>Expense Tracker</h2>

<div class="period-filter">
  <form method="GET" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
    <label for="period">–ü–µ—Ä–∏–æ–¥:</label>
    <select name="period" id="period" style="padding: 6px;">
      <option value="all" {% if period == 'all' %}selected{% endif %}>–í—Å–µ</option>
      <option value="last_week" {% if period == 'last_week' %}selected{% endif %}>–ü–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è</option>
      <option value="last_month" {% if period == 'last_month' %}selected{% endif %}>–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü</option>
    </select>

    <label for="start_date">–°:</label>
    <input type="date" id="start_date" name="start_date" value="{{ start_date|default:'' }}" />

    <label for="end_date">–ü–æ:</label>
    <input type="date" id="end_date" name="end_date" value="{{ end_date|default:'' }}" />

    <button type="submit" style="padding: 6px 12px; cursor: pointer;">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
  </form>
</div>

<div class="balance-container">
  <div class="balance-info">
    <h4>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</h4>
    <h1 id="balance">{{ profile.balance }} KZT</h1>
  </div>

  <div id="income-block" class="balance-info" >
    <h4>–î–æ—Ö–æ–¥—ã</h4>
    <p id="money-plus" class="money plus">+{{ profile.income }} KZT</p>
  </div>

  <div id="expense-block" class="balance-info">
    <h4>–†–∞—Å—Ö–æ–¥—ã</h4>
    <p id="money-minus" class="money minus">-{{ profile.expenses }} KZT</p>
  </div>
</div>

<h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
<div id="expense-categories" class="categories">
  {% for cat in category_expense %}
    <div class="category-card">
      <h4>{{ cat.name }}</h4>
      <p>{{ cat.total|default:0 }} KZT</p>
    </div>
  {% endfor %}
</div>

<div id="income-categories" class="categories" style="display: none;">
  {% for cat in category_income %}
    <div class="category-card">
      <h4>{{ cat.name }}</h4>
      <p>{{ cat.total|default:0 }} KZT</p>
    </div>
  {% endfor %}
</div>

<h3>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
<ul id="list" class="transaction-list">
  {% for transaction in expenses %}
    <li class="{% if transaction.expense_type == 'Positive' %}plus{% else %}minus{% endif %}">
      <span><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {{ transaction.name }}</span>
      <span><strong>–°—É–º–º–∞:</strong> {{ transaction.amount }} KZT</span>
      <span><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong>
        {% if transaction.category %}
          {{ transaction.category.name }}
        {% else %}
          –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        {% endif %}
      </span>
      <span><strong>–î–∞—Ç–∞:</strong> {{ transaction.date|date:"Y-m-d H:i" }}</span>
      <span>
        <!-- Delete button -->
        <a href="{% url 'delete_transaction' transaction.id %}" 
           onclick="return confirm('–¢—ã —Ç–æ—á–Ω–æ —Ö–æ—á–µ—à—å —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ–ø–µ—Ä–∞—Ü–∏—é?');" 
           style="color: #f55; margin-left: 15px; text-decoration: none;" 
           title="–£–¥–∞–ª–∏—Ç—å">
           üóë
        </a>

        <!-- Edit button -->
        <a href="{% url 'edit_transaction' transaction.id %}" 
           style="color: #4e73df; margin-left: 10px; text-decoration: none;" 
           title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
           ‚úé
        </a>
      </span>
    </li>
  {% endfor %}
</ul>

<div class="button-block">
  <button id="open-modal-btn">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span id="close-modal-btn" class="close-btn">&times;</span>
    <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h3>
    <form id="form" method="POST">
      {% csrf_token %}
      <div class="form-control">
        <label for="text">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <input type="text" name="text" id="text" placeholder="Enter text..." required />
      </div>
      <div class="form-control">
        <label for="amount">–°—É–º–º–∞ <br /></label>
        <input type="number" name="amount" id="amount" placeholder="Enter amount..." required />
      </div>
      <div class="form-control">
        <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select name="category" id="category">
            <option value="" selected>–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
        </select>
        <a href="{% url 'add_category' %}" style="margin-left:10px; font-size: 0.9rem;">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</a>
      </div>
      <div class="form-control">
        <label for="date">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
        <input type="datetime-local" name="date" id="date" value="{{ current_datetime|date:'Y-m-d\TH:i' }}" required />
      </div>
      <div class="form-control">
        <label for="expense_type">–¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</label>
        <select name="expense_type" required>
          <option value="Positive">–î–æ—Ö–æ–¥</option>
          <option value="Negative">–†–∞—Å—Ö–æ–¥</option>
        </select>
      </div>
      <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</button>
    </form>
  </div>
</div>

<script>
  const incomeBlock = document.getElementById('income-block');
  const expenseBlock = document.getElementById('expense-block');
  const incomeCategories = document.getElementById('income-categories');
  const expenseCategories = document.getElementById('expense-categories');

  function activateBlock(active, inactive) {
    active.classList.add('active-tab');
    inactive.classList.remove('active-tab');
  }

  incomeBlock.addEventListener('click', () => {
    incomeCategories.style.display = 'flex';
    expenseCategories.style.display = 'none';
    activateBlock(incomeBlock, expenseBlock);
  });

  expenseBlock.addEventListener('click', () => {
    incomeCategories.style.display = 'none';
    expenseCategories.style.display = 'flex';
    activateBlock(expenseBlock, incomeBlock);
  });

  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º "–†–∞—Å—Ö–æ–¥—ã"
  activateBlock(expenseBlock, incomeBlock);
  incomeCategories.style.display = 'none';
</script>
{% endblock %}